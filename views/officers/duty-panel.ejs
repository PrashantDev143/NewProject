<%- include('../partials/header') %>

<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="bi bi-person-badge"></i> Duty Panel
                <span class="text-muted fs-6">Welcome, Officer <%= user.name %>!</span>
            </h1>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <i class="bi bi-calendar-check fs-1 mb-2"></i>
                    <h3><%= events.length %></h3>
                    <p class="mb-0">Assigned Events</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="bi bi-geo-alt fs-1 mb-2"></i>
                    <h3><%= recentCheckIns.length %></h3>
                    <p class="mb-0">Recent Check-ins</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <i class="bi bi-clock fs-1 mb-2"></i>
                    <h3 id="currentTime">00:00:00</h3>
                    <p class="mb-0">Current Time</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Assigned Events -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-list-task"></i> Your Assigned Events</h5>
                </div>
                <div class="card-body">
                    <% if (events.length > 0) { %>
                        <% events.forEach(event => { %>
                            <div class="event-card mb-3 p-4 border rounded position-relative">
                                <div class="row">
                                    <div class="col-md-8">
                                        <h5 class="mb-2">
                                            <%= event.name %>
                                            <span class="badge bg-<%= event.status === 'active' ? 'success' : 'primary' %> ms-2">
                                                <%= event.status %>
                                            </span>
                                        </h5>
                                        <p class="text-muted mb-2">
                                            <i class="bi bi-calendar"></i> 
                                            <%= new Date(event.date).toLocaleDateString() %> at <%= event.time %>
                                        </p>
                                        <p class="text-muted mb-0">
                                            <i class="bi bi-geo-alt"></i> 
                                            Lat: <%= event.location.coordinates[1].toFixed(4) %>, 
                                            Lon: <%= event.location.coordinates[0].toFixed(4) %>
                                        </p>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <div class="btn-group-vertical" role="group">
                                            <button class="btn btn-success btn-sm mb-2" 
                                                    onclick="checkIn('<%= event._id %>')">
                                                <i class="bi bi-geo-alt"></i> Check In
                                            </button>
                                            <button class="btn btn-outline-warning btn-sm" 
                                                    onclick="requestHoliday('<%= event._id %>')">
                                                <i class="bi bi-calendar-minus"></i> Request Holiday
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Location tracking status -->
                                <div class="mt-3 pt-3 border-top">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>
                                            <small class="text-muted">Location Tracking:</small>
                                            <span id="tracking-<%= event._id %>" class="badge bg-secondary ms-2">Inactive</span>
                                        </div>
                                        <button class="btn btn-outline-primary btn-sm" 
                                                onclick="toggleTracking('<%= event._id %>')">
                                            <i class="bi bi-broadcast"></i> Start Tracking
                                        </button>
                                    </div>
                                </div>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <div class="text-center py-5">
                            <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                            <h4 class="text-muted mt-3">No Events Assigned</h4>
                            <p class="text-muted">You don't have any events assigned at the moment.</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- Quick Actions & Status -->
        <div class="col-lg-4">
            <!-- Location Status -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-geo-alt-fill"></i> Location Status</h5>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <div id="locationStatus" class="mb-3">
                            <i class="bi bi-geo-alt text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted">Location access required</p>
                        </div>
                        <button class="btn btn-primary" onclick="getLocation()">
                            <i class="bi bi-geo-alt"></i> Enable Location
                        </button>
                    </div>
                    <div id="currentLocation" class="mt-3 d-none">
                        <hr>
                        <small class="text-muted">Current Position:</small>
                        <div id="coordinates" class="font-monospace small"></div>
                    </div>
                </div>
            </div>

            <!-- Recent Check-ins -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-clock-history"></i> Recent Check-ins</h5>
                </div>
                <div class="card-body">
                    <% if (recentCheckIns.length > 0) { %>
                        <div class="timeline">
                            <% recentCheckIns.forEach(checkIn => { %>
                                <div class="timeline-item mb-3">
                                    <div class="d-flex">
                                        <div class="flex-shrink-0">
                                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" 
                                                 style="width: 40px; height: 40px;">
                                                <i class="bi bi-geo-alt text-white"></i>
                                            </div>
                                        </div>
                                        <div class="flex-grow-1 ms-3">
                                            <h6 class="mb-1">Check-in</h6>
                                            <p class="text-muted small mb-1">
                                                <%= new Date(checkIn.timestamp).toLocaleString() %>
                                            </p>
                                            <span class="badge bg-<%= checkIn.status === 'active' ? 'success' : checkIn.status === 'idle' ? 'warning' : 'danger' %>">
                                                <%= checkIn.status %>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                    <% } else { %>
                        <div class="text-center py-3">
                            <i class="bi bi-clock text-muted" style="font-size: 2rem;"></i>
                            <p class="text-muted mt-2 mb-0">No check-ins yet</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Holiday Request Modal -->
<div class="modal fade" id="holidayModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Request Holiday</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="holidayForm">
                    <input type="hidden" id="holidayEventId">
                    <div class="mb-3">
                        <label class="form-label">Reason for Holiday</label>
                        <textarea class="form-control" name="reason" rows="3" required 
                                  placeholder="Please provide a detailed reason for your holiday request..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Proof Document (Optional)</label>
                        <input type="file" class="form-control" name="proofFile" 
                               accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitHolidayRequest()">
                    <i class="bi bi-send"></i> Submit Request
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentPosition = null;
let trackingIntervals = {};

// Update current time
function updateTime() {
    const now = new Date();
    document.getElementById('currentTime').textContent = now.toLocaleTimeString();
}

// Update time every second
setInterval(updateTime, 1000);
updateTime();

// Get current location
function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                currentPosition = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude
                };
                
                updateLocationDisplay();
            },
            (error) => {
                console.error('Location error:', error);
                alert('Unable to get your location. Please enable location services.');
            }
        );
    } else {
        alert('Geolocation is not supported by this browser.');
    }
}

function updateLocationDisplay() {
    if (currentPosition) {
        document.getElementById('locationStatus').innerHTML = `
            <i class="bi bi-geo-alt-fill text-success" style="font-size: 3rem;"></i>
            <p class="text-success">Location enabled</p>
        `;
        
        document.getElementById('coordinates').textContent = 
            `${currentPosition.latitude.toFixed(6)}, ${currentPosition.longitude.toFixed(6)}`;
        document.getElementById('currentLocation').classList.remove('d-none');
    }
}

// Check-in function
async function checkIn(eventId) {
    if (!currentPosition) {
        alert('Please enable location access first.');
        getLocation();
        return;
    }
    
    try {
        const response = await fetch(`/officers/${eventId}/checkin`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                latitude: currentPosition.latitude,
                longitude: currentPosition.longitude
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Check-in successful!');
            location.reload();
        } else {
            alert('Check-in failed: ' + result.error);
        }
    } catch (error) {
        console.error('Check-in error:', error);
        alert('Check-in failed');
    }
}

// Toggle location tracking
function toggleTracking(eventId) {
    const trackingStatus = document.getElementById(`tracking-${eventId}`);
    const button = event.target;
    
    if (trackingIntervals[eventId]) {
        // Stop tracking
        clearInterval(trackingIntervals[eventId]);
        delete trackingIntervals[eventId];
        
        trackingStatus.textContent = 'Inactive';
        trackingStatus.className = 'badge bg-secondary ms-2';
        button.innerHTML = '<i class="bi bi-broadcast"></i> Start Tracking';
        button.className = 'btn btn-outline-primary btn-sm';
    } else {
        // Start tracking
        if (!currentPosition) {
            alert('Please enable location access first.');
            getLocation();
            return;
        }
        
        trackingIntervals[eventId] = setInterval(() => {
            sendLocationUpdate(eventId);
        }, 30000); // Send location every 30 seconds
        
        trackingStatus.textContent = 'Active';
        trackingStatus.className = 'badge bg-success ms-2';
        button.innerHTML = '<i class="bi bi-stop-circle"></i> Stop Tracking';
        button.className = 'btn btn-outline-danger btn-sm';
        
        // Send initial location
        sendLocationUpdate(eventId);
    }
}

function sendLocationUpdate(eventId) {
    if (!currentPosition) return;
    
    // Get updated location
    navigator.geolocation.getCurrentPosition((position) => {
        currentPosition = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude
        };
        
        // Send via Socket.IO
        const socket = io();
        socket.emit('location-update', {
            eventId,
            officerId: '<%= user.id %>',
            location: {
                type: 'Point',
                coordinates: [currentPosition.longitude, currentPosition.latitude]
            },
            status: 'active'
        });
    });
}

// Holiday request functions
function requestHoliday(eventId) {
    document.getElementById('holidayEventId').value = eventId;
    const modal = new bootstrap.Modal(document.getElementById('holidayModal'));
    modal.show();
}

async function submitHolidayRequest() {
    const eventId = document.getElementById('holidayEventId').value;
    const form = document.getElementById('holidayForm');
    const formData = new FormData(form);
    
    try {
        const response = await fetch(`/officers/${eventId}/holiday`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Holiday request submitted successfully!');
            bootstrap.Modal.getInstance(document.getElementById('holidayModal')).hide();
            form.reset();
        } else {
            alert('Failed to submit request: ' + result.error);
        }
    } catch (error) {
        console.error('Holiday request error:', error);
        alert('Failed to submit request');
    }
}

// Auto-enable location on page load
window.addEventListener('load', () => {
    setTimeout(getLocation, 1000);
});
</script>

<%- include('../partials/footer') %>